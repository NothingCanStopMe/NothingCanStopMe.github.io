---
title: 如果给鱼添加简单阴影
date: 2019-06-21 09:26:11
tags: 笔记
---

捕鱼项目里, 经常应策划需求要添加一个简单的阴影
因为我们项目里面鱼是2d的, 理论上在鱼的底下添加一个同外形的黑色的鱼就可以达到这个效果
基于此思路, 在鱼的文件内添加一个 schduler 每0.2秒执行一遍渲染
下面是代码:

{% codeblock %}
	function FishBase:initShadowUpdate()
		self.shadowSp = cc.Sprite:create()
		self.shadowSp:initWithSpriteFrameName("fishFrameName.png") -- 自行添加自己鱼的frameName
		self.shadowSp:setBlendFunc(cc.blendFunc(GL_ZERO, GL_ONE_MINUS_SRC_ALPHA)) -- 这个地方自行百度
		self.shadowSp:setOpacity(150)
		self.shadowSp:setPosition(cc.p(-10, 0))
		self.shadowSp:addTo(self, -1)
		self.shadowSp:scheduleUpdateWithPriorityLua(handler(self, self.shadowUpdate), 0.1)
	end

	function FishBase:shadowUpdate(dt)
		self.shadowSp:initWithSpriteFrame(self.aniSp:getSpriteFrame()) -- self.aniSp 为鱼的sprite
		self.shadowSp:setOpacity(150) --这里必须先设置不透明度, 不然setBlendFunc之后不再渲染透明度
		self.shadowSp:setBlendFunc(cc.blendFunc(GL_ZERO, GL_ONE_MINUS_SRC_ALPHA))

		-- 这里的计算是假设光源在右边, 且是方向光
		local x = math.sin(math.rad(self:getRotation() - 90)) * 15
		local y = - math.cos(math.rad(self:getRotation() - 90)) * 15
		self.shadowSp:setPosition(cc.p(x, y))
	end
{% endcodeblock %}

用setBlendFunc比直接用opengl更简单一些, 不需要自己写opengl文件, 直接混色就能达到要求了